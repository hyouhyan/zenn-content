---
title: "Valorantプレイ中にPCがブルスクになる原因がHyper-Vの「外部スイッチ」だった話"
emoji: "🎮"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Windows11", "HyperV", "Valorant", "ネットワーク", "備忘録"]
published: true
---

## はじめに
2年ぶりに「Valorantやるぞ！」と意気込んで起動しました。
久しぶりのマッチ、気合を入れてプレイを開始したのですが……**3分ほどでブルスク（BSOD）が発生してPCが強制再起動。**

「まあ、たまにはあるか」と思い再接続するも、また数分でクラッシュ。
まともに遊べないどころか、味方に迷惑をかけまくる悲惨な状況に。

色々と調査した結果、原因が**「開発環境（Hyper-V）の設定」**にあったことが判明したので、備忘録として残します。

## 発生した事象
Valorantのマッチ中、以下の挙動を経てPCがクラッシュします。

[![Image from Gyazo](https://i.gyazo.com/c7b87eae3b6148c91d24171cf80b540d.jpg)](https://gyazo.com/c7b87eae3b6148c91d24171cf80b540d)

### 具体的な挙動
1.  **ネットワークが不安定になる**
    * Valorantの画面右上に「ネットワーク問題あり」の表示が出る。
    * 弾抜けが頻発し、Discordの通話もプツプツと途切れる。
2.  **インターネットが一瞬切断される**
    * Windowsタスクバーのイーサネット接続アイコンが「切断（地球儀マーク）」になり、数秒後に復活する挙動を繰り返す。
3.  **Vanguardが高負荷に**
    * タスクマネージャーを見ると、クラッシュ直前にRiot Vanguard（アンチチート）が活発になり、メモリとディスクアクセスが急増している。
4.  **ブルスク（BSOD）発生**

### 表示されたエラーコード
一定ではなく、毎回異なるエラーが表示されました。
* `MEMORY_MANAGEMENT`
* `SECURITY_CHECK_FAILURE`
* `KERNEL_MODE_HEAP_CORRUPTION`
* `IRQL_NOT_LESS_OR_EQUAL`

これだけバラバラだとハードウェア故障（メモリなど）を疑いたくなりますが、**「普段の開発業務やブラウジングでは一切起きない」**ため、Valorant（特にVanguard）との競合を疑いました。

## 原因：Hyper-Vの「外部仮想スイッチ」
結論から言うと、**Hyper-Vで作成していた「外部（External）仮想スイッチ」が原因**でした。

私は普段、VMにLAN内のプライベートIPアドレスを直接割り当てるため、物理NICをHyper-Vにバインドさせていました。

[![Image from Gyazo](https://i.gyazo.com/5e154a067ec308df4387aeb4c303eab6.png)](https://gyazo.com/5e154a067ec308df4387aeb4c303eab6)

### 何が起きていたのか
「仮想スイッチの設定なんてVMの中にしか影響しないだろう」と思っていましたが、**「外部ネットワーク」**として設定した場合、ホストOSの通信経路も大きく変わります。

1.  **物理NICが乗っ取られる**
    * 物理NIC自体はHyper-Vのスイッチ専用になり、Windows OS（ホスト）から直接制御できなくなります。
2.  **vEthernet経由の通信になる**
    * ホストOSは、Hyper-Vが生成した仮想NIC（`vEthernet`）を経由してインターネットに接続します。

どうやら、この**「間にHyper-Vのスイッチ機能が挟まる」**という構成と、カーネルモードで動作して通信を監視する**Vanguard**が盛大に競合（喧嘩）していたようです。
特にRealtek製のNICドライバーを使っている場合、この構成で負荷がかかるとドライバーごとクラッシュする事例があるようです。

## 解決策
**Hyper-Vの仮想スイッチマネージャーから、対象の外部スイッチを削除しました。**

削除したことで、Windowsが物理NICを直接制御する（一般的なPCの）構成に戻りました。

* **削除前（vEthernet経由）**
    [![Image from Gyazo](https://i.gyazo.com/eafa60b26e2d4dfee708396e5094638c.png)](https://gyazo.com/eafa60b26e2d4dfee708396e5094638c)
* **削除後（物理NIC直結）**
    [![Image from Gyazo](https://i.gyazo.com/abae50e3eb5ea2b74e121485b0505a07.png)](https://gyazo.com/abae50e3eb5ea2b74e121485b0505a07)

この対応を行った後、ネットワーク断もブルスクも一切発生せず、平和にValorantをプレイできるようになりました。

## 余談

### 開発環境（VMのIP）どうする？
今回の対応でゲームは安定しましたが、VMに独立したIPを振れなくなるのは開発者として困ります。
解決策としては、**「USBのLANアダプター（ドングル）を増設する」**のが一番平和そうです。

* オンボードNIC → ゲーム・普段使い用
* USB NIC → Hyper-Vの外部スイッチ用

物理的に分けてしまえば、Vanguardに監視されるメイン回線に仮想スイッチが絡まないので事故りません。

### ブルスクの色が黒い？
Windows 11では，夏頃からからブルスク（Blue Screen）が黒背景（Black Screen）になったそう。
[Windowsのブルースクリーン、今夏からブラックスクリーンに](https://www.itmedia.co.jp/news/articles/2506/27/news055.html)

情報共有したりとかググったりとか、何かと「ブルスク」って言い続けちゃうよなあ…
(XをTwitterと呼び続ける心理に似てそう)


---


てなわけで、みんなも気をつけて！
楽しい開発ライフ&Valorantライフを！！
